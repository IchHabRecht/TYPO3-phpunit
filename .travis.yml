language: php
php:
  - 5.3
  - 5.4
  - 5.5

env:
  - DB=mysql TYPO3=master INTEGRATION=master
  - DB=mysql TYPO3=TYPO3_6-1 INTEGRATION=master
  - DB=mysql TYPO3=TYPO3_6-0 INTEGRATION=master
  - DB=mysql TYPO3=TYPO3_4-7 INTEGRATION=TYPO3_4-7
  - DB=mysql TYPO3=TYPO3_4-5 INTEGRATION=TYPO3_4-7

matrix:
  include:
    - php: 5.5
      env: DB=mysql TYPO3=master INTEGRATION=master

services:
  - memcached

before_script:
# Install build dependencies
  - cd ..
  - git clone --single-branch --branch $INTEGRATION --depth 1 https://github.com/Konafets/TYPO3-Travis-Integration build-environment
  - git clone --single-branch --branch $TYPO3 --depth 1 git://git.typo3.org/TYPO3v4/Distributions/Introduction.git build-environment/Introduction/
  - git clone --single-branch --branch $TYPO3 --depth 1 https://github.com/TYPO3/TYPO3.CMS.git core
  - git clone --single-branch --branch master --depth 1 git://github.com/etobi/ext-coreapi build-environment/Introduction/typo3conf/ext/coreapi
  - source build-environment/install-helper.sh
  - if [[ "$TRAVIS_PHP_VERSION" != "5.5" ]]; then installPhpModule igbinary; fi
  - installPhpModule -y memcache
  - installPhpModule redis
  - if [[ "$TRAVIS_PHP_VERSION" == "5.3" ]]; then installPhpModule -y apc; fi
# Install rudimentary TYPO3
  - ln -s $PWD/core build-environment/Introduction/typo3_src
  - cd build-environment/Introduction/
  - ln -s typo3_src/typo3
  - ln -s typo3_src/index.php
  - if [[ -d typo3_src/t3lib ]]; then ln -s typo3_src/t3lib; fi
  - cd ../../
  - if [[ -f build-environment/typo3conf/LocalConfiguration.php ]]; then mv build-environment/typo3conf/LocalConfiguration.php build-environment/Introduction/typo3conf/; fi 
  - if [[ -f build-environment/typo3conf/localconf.php ]]; then mv build-environment/typo3conf/localconf.php build-environment/Introduction/typo3conf/; fi
  - cp build-environment/Composer.json ext-phpunit/Composer/
  - cd ext-phpunit/Composer/
  - mv Composer.json composer.json
  - if [[ "$TRAVIS_PHP_VERSION" != "5.3" ]]; then composer update; fi
  - cd ../../
  - cp -r ext-phpunit build-environment/Introduction/typo3conf/ext/
  - mv build-environment/Introduction/typo3conf/ext/ext-phpunit build-environment/Introduction/typo3conf/ext/phpunit
  - cp -r ext-phpunit/TestExtensions/aaa build-environment/Introduction/typo3conf/ext/
  - cp -r ext-phpunit/TestExtensions/bbb build-environment/Introduction/typo3conf/ext/
  - cp -r ext-phpunit/TestExtensions/ccc build-environment/Introduction/typo3conf/ext/
  - cp -r ext-phpunit/TestExtensions/user_phpunittest build-environment/Introduction/typo3conf/ext/
  - cp -r ext-phpunit/TestExtensions/user_phpunittest2 build-environment/Introduction/typo3conf/ext/
  - if [[ "$DB" == "mysql" ]]; then mysql -e "DROP DATABASE IF EXISTS typo3_test;" -uroot; fi
  - if [[ "$DB" == "mysql" ]]; then mysql -e "create database typo3_test;" -uroot; fi
  - if [[ "$DB" == "mysql" ]]; then mysql -uroot typo3_test < build-environment/Introduction/typo3conf/ext/introduction/Resources/Private/Subpackages/Introduction/Database/introduction.sql; fi
  - if [[ "$DB" == "mysql" && -f build-environment/dbimport/cache_tables.sql ]]; then mysql -uroot typo3_test < build-environment/dbimport/cache_tables.sql; fi
  - if [[ "$DB" == "mysql" && -f build-environment/dbimport/cli_users.sql ]]; then mysql -uroot typo3_test < build-environment/dbimport/cli_users.sql; fi
  - cd  build-environment/Introduction
  - php $PWD/typo3/cli_dispatch.phpsh coreapi cache:clearallcaches
  - php $PWD/typo3/cli_dispatch.phpsh coreapi database:databasecompare 1,2,3,4,5,6,7,8
  - php $PWD/typo3/cli_dispatch.phpsh coreapi extension:createuploadfolders
  - php $PWD/typo3/cli_dispatch.phpsh coreapi cache:clearallcaches
  # Here its an experimental feature. I tried to make PHP_CodeSniffer running but it doesn't work for the moment.
  # It installs PHP_CodeSniffer and the TYPO3CMS CGL standard via composer
  # But the custom standards won't be found
  #- cd ext-phpunit
  #- composer install --verbose
  #- vendor/bin/phpcs --version
  #- vendor/bin/phpcs -i
  #- ls -lah vendor/squizlabs/php_codesniffer/CodeSniffer/Standards/TYPO3Sniffpool/Sniffs/Classes/
  #- cd ..

script:
  #- $PWD/ext-phpunit/vendor/bin/phpcs --standard=TYPO3CMS --ignore=PEAR --warning-severity=0 --extensions=php,inc -sv $PWD/ext-phpunit
  - php $PWD/typo3/cli_dispatch.phpsh phpunit -c $PWD/typo3conf/ext/phpunit/Tests/Build/UnitTests.xml
  - find -L $PWD/typo3conf/ext/phpunit -name '*.php' -print0 | xargs -0 -n 1 -P 4 php -l
